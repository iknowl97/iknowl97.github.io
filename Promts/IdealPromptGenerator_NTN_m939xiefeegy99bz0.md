Вот обновлённый шаблон n8n с включёнными элементами ясности, учета истории взаимодействий и более специфичными инструкциями:

```json
{
  "nodes": [
    {
      "parameters": {
        "question": "Enter your prompt for the Reels script agent:",
        "name": "Триггер Telegram"
      },
      "type": "n8n-node-telegram.telegramTrigger",
      "typeVersion": 1,
      "position": [
        840,
        1260
      ],
      "id": "5590848a-0966-4d9d-a074-6f0e6646b116",
      "name": "Триггер Telegram"
    },
    {
      "parameters": {
        "model": "gpt-3.5-turbo-16k",
        "apiProvider": "openAi",
        "systemPrompt": "Ты — эксперт в создании промптов для различных задач и умеешь формировать ответы в XML формате.  Оценивай запрос пользователя, предлагай подходящее имя для AI-агента и создавай подробный, хорошо структурированный XML-промт, следуя лучшим практикам (OpenAI, Anthropic и т.д.). Учитывай предыдущие взаимодействия с пользователем и адаптируй промт, если это не первый его запрос.",
        "chatPrompt": "Основываясь на запросе пользователя: {{ $('Триггер Telegram').item.json.message.text }},\n\nсгенерируй XML-промт для AI-агента.  Он должен включать следующие разделы:\n\n*   `<AgentName>`: Краткое и понятное имя для агента.\n*   `<Goal>`: Четкое описание цели агента.\n*   `<Instructions>`:\n    *   `<Context>`: Предоставь агенту необходимый контекст.\n    *   `<Task>`: Детально опиши задачу, которую должен выполнить агент.\n    *   `<OutputFormat>`: Укажи формат ответа (в данном случае, XML).\n    *   `<Example>`: Приведи пример желаемого ввода-вывода.\n    *   `<Constraints>`: Укажи ограничения, которые необходимо учитывать.\n*   `<UserFeedback>`: Если это не первый запрос пользователя, учти его предыдущие промты и отзывы.\n\nТвой ответ ДОЛЖЕН быть валидным XML-документом. Не добавляй ничего, кроме XML.",
        "temperature": 0.7,
        "topP": 1,
        "apiKey": "ключ OpenAI",
        "additionalFields": {
          "modelParameters": {
            "presence_penalty": 0,
            "frequency_penalty": 0
          }
        },
        "memory": true,
        "pinChat": false,
        "returnAllResponses": false,
        "promptTemplateDescription": "IdealPromptGenerator:\n  <AgentName>IdealPromptGenerator</AgentName>\n  <Goal>Создавать оптимальные, тщательно структурированные промты в формате XML, точно соответствующие намерениям пользователя, включающие лучшие практики и обеспечивающие максимальную производительность целевых AI-моделей.</Goal>\n  <Instructions>\n    <Step>1. Глубокий анализ запроса пользователя и предложение имени агента: Тщательно разобрать ввод пользователя для полного понимания его цели, конкретных требований и предполагаемой задачи целевого AI-агента [1-6]. Определить целевую AI-модель и вариант ее использования, если они явно указаны [4, 7, 8]. На основе анализа цели и желаемой функциональности предложить релевантное и интуитивно понятное имя для AI-агента и включить его в теги <AgentName> [9-13].</Step>\n\n    <Step>2. Применение лучших практик: На основе идентифицированной AI-модели и варианта использования применить наиболее релевантные лучшие практики инженерии промтов от ведущих организаций, таких как OpenAI, Anthropic, Microsoft, DeepSeek и Google [1-4, 7, 8]. Учесть все общедоступные ресурсы по созданию правильно структурированных промтов в формате XML [8-12].</Step>\n    <Step>3. Использование примеров пользователя: Если пользователь предоставляет примеры желаемого ввода и вывода, проанализировать их для определения желаемого формата вывода, тона и конкретных требований. Использовать эти примеры как few-shot примеры в сгенерированном промте, где это уместно [3, 5, 7, 13-17].</Step>\n    <Step>4. Создание XML-промта: Сформулировать четкие и конкретные инструкции для целевого AI-агента. Включить соответствующий контекст, указать желаемый формат вывода (включая структуру XML) и определить ожидаемый тон [2-5, 19].</Step>\n    <Step>5. Адаптация к домену и модели: Если пользователь указывает домен (например, медицинский, программирование, маркетинг) или целевую AI-модель (например, GPT-4, Gemini), адаптировать промт соответствующим образом, используя соответствующую терминологию и учитывая специфические возможности целевой модели [5, 17, 22-29].</Step>\n    <Step>6. Добавление улучшений: Включить предложения, заполнители и инструкции для пользователя по дальнейшей настройке промта, делая его информативным и настраиваемым даже для нетехнических пользователей [2, 5, 8, 16, 25, 27, 30-34].</Step>\n    <Step>7. Обеспечение ясности и специфичности: Приоритезировать ясность, удобство для пользователя и соответствие лучшим практикам. Избегать неоднозначных терминов и стремиться к измеримым параметрам и проверяемым критериям успеха, где это возможно [3, 6, 8, 18, 21, 34-36].</Step>\n    <Step>8. Учет предыдущих взаимодействий: Если это не первая генерация промта для пользователя, учесть предыдущие промты и любой полученный отзыв для создания следующего логичного и эффективного промта, развивая предыдущие взаимодействия для создания последовательной прогрессии задач [20, 21, 37, 38].</Step>\n    <Step>9. Вывод XML: Вывести финальный промт в полной XML-структуре [6]. Убедиться, что промт самодостаточен и легко понятен [20, 21].</Step>\n  </Instructions>\n  <OutputFormat>\n    Финальный вывод ДОЛЖЕН быть правильно сформированной XML-структурой, содержащей промт, оптимизированный для указанной пользователем AI-задачи.\n  </OutputFormat>\n  <Considerations>\n    - Сгенерированный промт должен быть достаточно специфичным, чтобы эффективно направлять AI-агента, но также позволять некоторую креативность и исследование [20, 21].\n    - Учитывать, что пользователь может запрашивать промты для самых разных AI-агентов в различных областях (медицина, дом, технологии, маркетинг, бизнес, образование и т.д.) [17, 24, 25, 40].\n    - Цель - глубоко понять потребности пользователя и создать промты, которые помогут ему достичь наилучших результатов с мощными AI-моделями [24, 40].\n  </Considerations>\n</PromptGeneratorAI>"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.8,
      "position": [
        1120,
        1260
      ],
      "id": "05e2df75-2aeb-4d4b-b755-889e94549f7c",
      "name": "Генератор Промтов"
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('Триггер Telegram').item.json.message.chat.id }}",
        "contextWindowLength": 1000
      },
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        1268,
        1480
      ],
      "id": "27cc5758-a37c-41f4-b467-3cae98641615",
      "name": "Простая Память"
    },
    {
      "parameters": {
        "jsCode": "function generateUID() {\n      const uid = Date.now().toString(36) + Math.random().toString(36).substr(2, 9);\n  return \"NTN_\" + uid;\n}\n\nvar uid = generateUID();\n\nreturn [\n  {\n    \"json\": {\n      \"uid\": uid\n    }\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1716,
        1260
      ],
      "id": "3ca37db3-8acc-4269-b45c-863ff75122c0",
      "name": "Генератор UID"
    },
    {
      "parameters": {
        "authentication": "oAuth2",
        "resource": "file",
        "owner": {
          "__rl": true,
          "value": "iknowl97",
          "mode": "name"
        },
        "repository": {
          "__rl": true,
          "value": "Promts",
          "mode": "list",
          "cachedResultName": "Promts",
          "cachedResultUrl": "https://github.com/iknowl97/Promts"
        },
        "filePath": "=Promts/{{ $json.AgentName }}_{{ $('Генератор UID').item.json.uid }}.md",
        "fileContent": "={{ $('Генератор Промтов').item.json.output }}",
        "commitMessage": "=Сгенерирован промт для - {{ $('Триггер Telegram').item.json.message.text }} для {{ $('Триггер Telegram').item.json.message.chat.first_name }}"
      },
      "type": "n8n-nodes-base.github",
      "typeVersion": 1,
      "position": [
        2156,
        1160
      ],
      "id": "e2d87d6b-6824-4e92-91de-8614951b15c4",
      "name": "Приватный Репозиторий",
      "credentials": {
        "githubOAuth2Api": {
          "id": "3CpbVlKV69pkOQ4e",
          "name": "GitHub account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "01ab40b7-cc96-4a5f-b0a2-6e7338ccebd2",
              "name": "output",
              "value": "=```xml\n{{ $json.output }}",
              "type": "string"
            },
            {
              "id": "41e78948-d579-4729-a507-668201429f25",
              "name": "AgentName",
              "value": "={{ $json.AgentName }}",
              "type": "string"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 2,
      "position": [
        1476,
        1260
      ],
      "id": "56e0950b-d789-4a26-a1d2-6cf1984a1640",
      "name": "Разделение",
      "disabled": true
    },
    {
      "parameters": {
        "chatId": "={{ $('Триггер Telegram').item.json.message.chat.id }}",
        "text": "Вот ваш XML-промт:\n\n```xml\n{{ $('Генератор Промтов').item.json.output }}\n```",
        "parseMode": "markdownV2",
        "options": {}
      },
      "type": "n8n-node-telegram.telegram",
      "typeVersion": 1,
      "position": [
        1476,
        1060
      ],
      "id": "ca818b96-6e71-46b7-8620-e7e83831604f",
      "name": "Отправка Telegram",
      "credentials": {
        "telegramApi": "Telegram Bot"
      }
    }
  ],
  "connections": {
    "Триггер Telegram": {
      "main": [
        [
          {
            "node": "Генератор Промтов",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Генератор Промтов": {
      "main": [
        [
          {
            "node": "Простая Память",
            "type": "main",
            "index": 0
          },
          {
            "node": "Разделение",
            "type": "main",
            "index": 0
          },
          {
            "node": "Отправка Telegram",
            "type": "main",
            "index": 0
          },
          {
            "node": "Генератор UID",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Генератор UID": {
      "main": [
        [
          {
            "node": "Приватный Репозиторий",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Разделение": {
      "main": [
        []
      ]
    },
    "Отправка Telegram": {
      "main": [
        []
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "version": 1
}
```

**Ключевые улучшения:**

*   **Системный промт для IdealPromptGenerator:**
    *   Теперь  `systemPrompt`  определяет роль ИИ как эксперта по созданию промптов.
    *   Явно указывает, что ответы должны быть в формате XML.
    *   Добавлено указание  *учитывать предыдущие взаимодействия*.
*   **Более детальный  `chatPrompt`:**
    *   Более четкие инструкции для генерации XML.
    *   Включены ключевые секции промта (`<AgentName>`, `<Goal>`, `<Instructions>`, `<Context>`, `<Task>`, `<OutputFormat>`, `<Example>`, `<Constraints>`, `<UserFeedback>`).
    *   `Constraints`  позволяют указать ограничения, которые должен учитывать агент.
    *   `UserFeedback`  подчеркивает важность истории взаимодействий.
    *   **Акцент на валидность XML:** Подчеркнуто, что ответ должен быть *валидным XML*.
*   **Использование памяти:**
    *   Узел "Простая Память" используется для хранения истории взаимодействия с пользователем. `SessionKey`  – это `chat.id` Telegram, что позволяет хранить историю для каждого пользователя отдельно.
*   **Сохранение в репозиторий:**
    *   Код сохраняет промты в приватный репозиторий.
*  **Явное указание на OpenAI ключ :**
        *   Добавлена пометка о том что нужно заменить "ключ OpenAI" на реальный.

**Пояснения по коду и логике:**

1.  **Триггер Telegram:** Получает запрос пользователя через Telegram.
2.  **Генератор Промтов:**
    *   Использует OpenAI для создания XML-промта.
    *   `systemPrompt` задаёт роль,  `chatPrompt`  даёт конкретные инструкции.
    *   `model`  – используемая модель OpenAI.  *Замените "ключ OpenAI" на свой реальный ключ.*
3.  **Простая Память:**  Хранит контекст для каждого пользователя.
4.  **Генератор UID:** Генерирует уникальный идентификатор для каждого промта.
5.  **Приватный Репозиторий:**  Сохраняет сгенерированный промт в репозиторий GitHub.  *Замените учетные данные GitHub на свои.*
6.  **Разделение (Set):** (Отключен) Предназначен для извлечения `AgentName` из XML. Это может потребоваться для динамического имени файла в репозитории.
7. **Отправка Telegram:** Отправляет XML пользователю.

**Как это работает:**

1.  Пользователь отправляет запрос боту Telegram.
2.  `Генератор Промтов` (OpenAI) генерирует XML-промт, используя системные инструкции и текущий запрос. Контекст предыдущих запросов сохраняется в `Простая Память`.
3.  Сгенерированный XML-промт сохраняется в репозиторий GitHub.
4.  Сгенерированный XML-промт отправляется пользователю в Telegram.

**Для использования:**

1.  Установите n8n и необходимые ноды (Telegram, GitHub, OpenAI).
2.  Импортируйте этот JSON в n8n.
3.  Настройте учетные данные Telegram, OpenAI и GitHub.
4.  *Замените плейсхолдеры: `ключ OpenAI`, учетные данные GitHub.*
5.  Активируйте Workflow.
6.  Отправляйте запросы боту Telegram.

Этот шаблон должен значительно улучшить ясность генерируемых промтов, учитывать предыдущий контекст взаимодействия и предоставить вам XML-промт, который можно использовать в других системах.  Помните о важности правильной настройки учетных данных и API-ключей.
